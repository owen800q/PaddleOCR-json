name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (e.g., v1.4.1)'
        required: false
        default: ''

env:
  PADDLE_VERSION: '3.0.0-beta1'
  OPENCV_VERSION: '4.5.4'

jobs:
  build-linux:
    runs-on: ubuntu-20.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          wget \
          unzip \
          libgomp1 \
          libglib2.0-0 \
          libsm6 \
          libxext6 \
          libxrender-dev

    - name: Cache PaddlePaddle
      id: cache-paddle-linux
      uses: actions/cache@v3
      with:
        path: cpp/.source/paddle_inference_manylinux_cpu_avx_mkl_gcc8.2
        key: paddle-linux-${{ env.PADDLE_VERSION }}-avx-mkl

    - name: Download PaddlePaddle Inference Library
      if: steps.cache-paddle-linux.outputs.cache-hit != 'true'
      working-directory: cpp
      run: |
        mkdir -p .source
        cd .source
        wget -q https://paddle-inference-lib.bj.bcebos.com/3.0.0-beta1/cxx_c/Linux/CPU/gcc8.2_avx_mkl/paddle_inference.tgz
        tar -xzf paddle_inference.tgz
        rm paddle_inference.tgz
        mv paddle_inference paddle_inference_manylinux_cpu_avx_mkl_gcc8.2

    - name: Cache OpenCV
      id: cache-opencv-linux
      uses: actions/cache@v3
      with:
        path: cpp/.source/opencv-4.5.4
        key: opencv-linux-${{ env.OPENCV_VERSION }}

    - name: Download and Build OpenCV
      if: steps.cache-opencv-linux.outputs.cache-hit != 'true'
      working-directory: cpp
      run: |
        mkdir -p .source
        cd .source
        wget -q -O opencv.zip https://github.com/opencv/opencv/archive/${OPENCV_VERSION}.zip
        unzip -q opencv.zip
        cd opencv-${OPENCV_VERSION}
        mkdir build && cd build
        cmake -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_INSTALL_PREFIX=../../opencv-${OPENCV_VERSION} \
              -DBUILD_LIST=core,imgproc,imgcodecs \
              -DBUILD_SHARED_LIBS=ON \
              -DBUILD_TESTS=OFF \
              -DBUILD_PERF_TESTS=OFF \
              -DBUILD_EXAMPLES=OFF \
              -DWITH_FFMPEG=OFF \
              -DWITH_GTK=OFF \
              -DWITH_V4L=OFF \
              -DWITH_OPENEXR=OFF \
              ..
        cmake --build . --config Release -j$(nproc)
        cmake --install .
        cd ../..
        rm -rf opencv-${OPENCV_VERSION}/build opencv.zip

    - name: Cache OCR Models
      id: cache-models
      uses: actions/cache@v3
      with:
        path: cpp/.source/models
        key: ocr-models-v4

    - name: Download OCR Models
      if: steps.cache-models.outputs.cache-hit != 'true'
      working-directory: cpp
      run: |
        mkdir -p .source/models
        cd .source/models

        # Download Chinese OCR models
        wget -q https://paddleocr.bj.bcebos.com/PP-OCRv4/chinese/ch_PP-OCRv4_det_infer.tar
        tar -xf ch_PP-OCRv4_det_infer.tar
        rm ch_PP-OCRv4_det_infer.tar

        wget -q https://paddleocr.bj.bcebos.com/PP-OCRv4/chinese/ch_PP-OCRv4_rec_infer.tar
        tar -xf ch_PP-OCRv4_rec_infer.tar
        rm ch_PP-OCRv4_rec_infer.tar

        wget -q https://paddleocr.bj.bcebos.com/dygraph_v2.0/ch/ch_ppocr_mobile_v2.0_cls_infer.tar
        tar -xf ch_ppocr_mobile_v2.0_cls_infer.tar
        rm ch_ppocr_mobile_v2.0_cls_infer.tar

        # Download dictionary
        wget -q https://raw.githubusercontent.com/PaddlePaddle/PaddleOCR/release/2.7/ppocr/utils/ppocr_keys_v1.txt -O dict_chinese.txt

        # Create config file
        echo "det_model_dir=ch_PP-OCRv4_det_infer" > config_chinese.txt
        echo "cls_model_dir=ch_ppocr_mobile_v2.0_cls_infer" >> config_chinese.txt
        echo "rec_model_dir=ch_PP-OCRv4_rec_infer" >> config_chinese.txt
        echo "rec_char_dict_path=dict_chinese.txt" >> config_chinese.txt

    - name: Build PaddleOCR-json
      working-directory: cpp
      run: |
        mkdir -p build && cd build
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DPADDLE_LIB=${GITHUB_WORKSPACE}/cpp/.source/paddle_inference_manylinux_cpu_avx_mkl_gcc8.2 \
          -DOPENCV_DIR=${GITHUB_WORKSPACE}/cpp/.source/opencv-${OPENCV_VERSION} \
          -DWITH_MKL=ON \
          -DWITH_GPU=OFF \
          -DWITH_STATIC_LIB=OFF
        cmake --build . --config Release -j$(nproc)

    - name: Package Linux Binary
      run: |
        cd cpp/build/bin
        tar -czf PaddleOCR-json-linux-x64.tar.gz PaddleOCR-json *.so*
        mv PaddleOCR-json-linux-x64.tar.gz ${GITHUB_WORKSPACE}/

    - name: Upload Linux Artifact
      uses: actions/upload-artifact@v4
      with:
        name: PaddleOCR-json-linux-x64
        path: PaddleOCR-json-linux-x64.tar.gz
        retention-days: 7

  build-windows:
    runs-on: windows-2022

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1.1

    - name: Cache PaddlePaddle
      id: cache-paddle-windows
      uses: actions/cache@v3
      with:
        path: cpp/.source/paddle_inference
        key: paddle-windows-${{ env.PADDLE_VERSION }}-mkl

    - name: Download PaddlePaddle Inference Library
      if: steps.cache-paddle-windows.outputs.cache-hit != 'true'
      working-directory: cpp
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path .source
        cd .source
        # Download PaddlePaddle 3.0.0-beta1 for Windows
        $url = "https://paddle-inference-lib.bj.bcebos.com/3.0.0-beta1/cxx_c/Windows/CPU/x86-64_avx-mkl-vs2019/paddle_inference.zip"
        Write-Host "Downloading PaddlePaddle from: $url"
        Invoke-WebRequest -Uri $url -OutFile paddle_inference.zip
        Expand-Archive -Path paddle_inference.zip -DestinationPath .
        Remove-Item paddle_inference.zip

    - name: Cache OpenCV
      id: cache-opencv-windows
      uses: actions/cache@v3
      with:
        path: |
          cpp/.source/opencv-build
          cpp/.source/opencv-install
        key: opencv-windows-${{ env.OPENCV_VERSION }}-vs2022-build

    - name: Download and Build OpenCV
      if: steps.cache-opencv-windows.outputs.cache-hit != 'true'
      working-directory: cpp
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path .source
        cd .source
        # Download OpenCV source code
        Invoke-WebRequest -Uri "https://github.com/opencv/opencv/archive/${env:OPENCV_VERSION}.zip" -OutFile opencv.zip
        Expand-Archive -Path opencv.zip -DestinationPath .
        cd opencv-${env:OPENCV_VERSION}

        # Create build directory
        New-Item -ItemType Directory -Force -Path build
        cd build

        # Configure OpenCV build with minimal modules for OCR
        cmake .. `
          -G "Visual Studio 17 2022" `
          -A x64 `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_INSTALL_PREFIX="../../opencv-install" `
          -DBUILD_LIST="core,imgproc,imgcodecs" `
          -DBUILD_SHARED_LIBS=ON `
          -DBUILD_TESTS=OFF `
          -DBUILD_PERF_TESTS=OFF `
          -DBUILD_EXAMPLES=OFF `
          -DWITH_FFMPEG=OFF `
          -DWITH_GTK=OFF `
          -DWITH_V4L=OFF `
          -DWITH_OPENEXR=OFF `
          -DBUILD_opencv_python2=OFF `
          -DBUILD_opencv_python3=OFF `
          -DBUILD_opencv_java=OFF `
          -DBUILD_opencv_apps=OFF `
          -DBUILD_opencv_js=OFF

        # Build OpenCV
        cmake --build . --config Release -j $env:NUMBER_OF_PROCESSORS

        # Install OpenCV
        cmake --install . --config Release

        # Move build directory to preserve it for CMake config
        cd ../..
        Move-Item -Path "opencv-${env:OPENCV_VERSION}/build" -Destination "opencv-build" -Force

        # Keep opencv-install directory (it was created by cmake --install)
        # Clean up only source files to save cache space
        Remove-Item -Recurse -Force opencv-${env:OPENCV_VERSION}
        Remove-Item opencv.zip

        # Verify install directory structure
        Write-Host "`nOpenCV install directory contents:"
        Get-ChildItem -Path opencv-install -Depth 1 | Select-Object FullName

        # Debug: Show OpenCV build directory structure
        Write-Host "OpenCV build directory structure:"
        Get-ChildItem -Path opencv-build -Depth 2 | Select-Object FullName

        # Check for OpenCVConfig.cmake location
        Write-Host "`nSearching for OpenCVConfig.cmake:"
        Get-ChildItem -Path opencv-build -Filter "OpenCVConfig.cmake" -Recurse | Select-Object FullName

    - name: Cache OCR Models
      id: cache-models-windows
      uses: actions/cache@v3
      with:
        path: cpp/.source/models
        key: ocr-models-v4

    - name: Download OCR Models
      if: steps.cache-models-windows.outputs.cache-hit != 'true'
      working-directory: cpp
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path .source/models
        cd .source/models

        # Download Chinese OCR models
        Invoke-WebRequest -Uri "https://paddleocr.bj.bcebos.com/PP-OCRv4/chinese/ch_PP-OCRv4_det_infer.tar" -OutFile det.tar
        tar -xf det.tar
        Remove-Item det.tar

        Invoke-WebRequest -Uri "https://paddleocr.bj.bcebos.com/PP-OCRv4/chinese/ch_PP-OCRv4_rec_infer.tar" -OutFile rec.tar
        tar -xf rec.tar
        Remove-Item rec.tar

        Invoke-WebRequest -Uri "https://paddleocr.bj.bcebos.com/dygraph_v2.0/ch/ch_ppocr_mobile_v2.0_cls_infer.tar" -OutFile cls.tar
        tar -xf cls.tar
        Remove-Item cls.tar

        # Download dictionary
        Invoke-WebRequest -Uri "https://raw.githubusercontent.com/PaddlePaddle/PaddleOCR/release/2.7/ppocr/utils/ppocr_keys_v1.txt" -OutFile dict_chinese.txt

        # Create config file
        "det_model_dir=ch_PP-OCRv4_det_infer" | Out-File -FilePath config_chinese.txt -Encoding ASCII
        "cls_model_dir=ch_ppocr_mobile_v2.0_cls_infer" | Out-File -FilePath config_chinese.txt -Encoding ASCII -Append
        "rec_model_dir=ch_PP-OCRv4_rec_infer" | Out-File -FilePath config_chinese.txt -Encoding ASCII -Append
        "rec_char_dict_path=dict_chinese.txt" | Out-File -FilePath config_chinese.txt -Encoding ASCII -Append

    - name: Build PaddleOCR-json
      working-directory: cpp
      shell: cmd
      run: |
        mkdir build
        cd build
        cmake .. ^
          -G "Visual Studio 17 2022" ^
          -A x64 ^
          -DCMAKE_BUILD_TYPE=Release ^
          -DPADDLE_LIB=%GITHUB_WORKSPACE%\cpp\.source\paddle_inference ^
          -DOPENCV_DIR=%GITHUB_WORKSPACE%\cpp\.source\opencv-build ^
          -DCMAKE_PREFIX_PATH=%GITHUB_WORKSPACE%\cpp\.source\opencv-install;%GITHUB_WORKSPACE%\cpp\.source\opencv-build ^
          -DWITH_MKL=ON ^
          -DWITH_GPU=OFF ^
          -DWITH_STATIC_LIB=ON
        cmake --build . --config Release -j %NUMBER_OF_PROCESSORS%

    - name: Copy OpenCV DLLs to output
      working-directory: cpp
      shell: pwsh
      run: |
        # Copy OpenCV DLLs from install directory
        if (Test-Path ".source/opencv-install/bin") {
            $opencvDlls = Get-ChildItem -Path ".source/opencv-install/bin" -Filter "*.dll" -ErrorAction SilentlyContinue
            if ($opencvDlls) {
                Write-Host "Copying OpenCV DLLs from install/bin to output directory"
                Copy-Item -Path ".source/opencv-install/bin/*.dll" -Destination "build/bin/Release/" -Force
            }
        }
        # Also check x64/vc17/bin structure (typical for Windows builds)
        if (Test-Path ".source/opencv-install/x64/vc17/bin") {
            $opencvDlls = Get-ChildItem -Path ".source/opencv-install/x64/vc17/bin" -Filter "*.dll" -ErrorAction SilentlyContinue
            if ($opencvDlls) {
                Write-Host "Copying OpenCV DLLs from install/x64/vc17/bin to output directory"
                Copy-Item -Path ".source/opencv-install/x64/vc17/bin/*.dll" -Destination "build/bin/Release/" -Force
            }
        }
        # Fallback: check build directory
        if (Test-Path ".source/opencv-build/bin/Release") {
            $opencvBuildDlls = Get-ChildItem -Path ".source/opencv-build/bin/Release" -Filter "*.dll" -ErrorAction SilentlyContinue
            if ($opencvBuildDlls) {
                Write-Host "Copying OpenCV DLLs from build/bin/Release to output directory"
                Copy-Item -Path ".source/opencv-build/bin/Release/*.dll" -Destination "build/bin/Release/" -Force
            }
        }

    - name: Package Windows Binary
      working-directory: cpp/build/bin/Release
      shell: pwsh
      run: |
        Compress-Archive -Path PaddleOCR-json.exe,*.dll -DestinationPath ${env:GITHUB_WORKSPACE}\PaddleOCR-json-windows-x64.zip

    - name: Upload Windows Artifact
      uses: actions/upload-artifact@v4
      with:
        name: PaddleOCR-json-windows-x64
        path: PaddleOCR-json-windows-x64.zip
        retention-days: 7

  create-release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.release_tag != ''

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Determine release tag
      id: get_tag
      run: |
        if [ "${{ github.event_name }}" == "push" ]; then
          TAG=${GITHUB_REF#refs/tags/}
        else
          TAG="${{ github.event.inputs.release_tag }}"
        fi
        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        echo "Release tag: ${TAG}"

    - name: Download Linux Artifact
      uses: actions/download-artifact@v4
      with:
        name: PaddleOCR-json-linux-x64
        path: ./artifacts

    - name: Download Windows Artifact
      uses: actions/download-artifact@v4
      with:
        name: PaddleOCR-json-windows-x64
        path: ./artifacts

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_tag.outputs.tag }}
        name: Release ${{ steps.get_tag.outputs.tag }}
        body: |
          ## PaddleOCR-json Release ${{ steps.get_tag.outputs.tag }}

          ### HTTP Server Features
          - RESTful API with JSON responses
          - Multipart form-data file uploads (POST /api/ocr)
          - Base64 image support (POST /api/ocr/base64)
          - Health check endpoint (GET /api/health)
          - Version info endpoint (GET /api/version)

          ### Downloads
          - **Linux x64**: PaddleOCR-json-linux-x64.tar.gz
          - **Windows x64**: PaddleOCR-json-windows-x64.zip

          ### Usage

          **Command Line:**
          ```bash
          ./PaddleOCR-json --image_path=test.jpg
          ```

          **HTTP Server Mode:**
          ```bash
          ./PaddleOCR-json --server --server_port=8080 --models_path=models --config_path=models/config_chinese.txt
          ```

          **Test with curl:**
          ```bash
          curl -X POST http://localhost:8080/api/ocr -F "image=@test.jpg"
          ```

          ### Requirements
          - Linux: Ubuntu 18.04+ or compatible
          - Windows: Windows 10+ with Visual C++ Redistributable 2022
          - Models: Download from [PaddleOCR Model Zoo](https://github.com/PaddlePaddle/PaddleOCR/blob/release/2.7/doc/doc_en/models_list_en.md)
        files: |
          ./artifacts/PaddleOCR-json-linux-x64.tar.gz
          ./artifacts/PaddleOCR-json-windows-x64.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
